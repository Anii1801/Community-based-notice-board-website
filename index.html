<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LocalLink:Community Hub</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Load Firebase Modules (v12.4.0) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-auth.js";
        import { getFirestore, collection, onSnapshot, query, addDoc, Timestamp, setLogLevel } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        // Set log level to see detailed Firebase messages
        setLogLevel('debug');

        // ðŸ”¥ðŸ”¥ðŸ”¥ YOUR ACTUAL FIREBASE CONFIGURATION ðŸ”¥ðŸ”¥ðŸ”¥
        const firebaseConfig = {
            apiKey: "AIzaSyDtaoj9UxTpzrR2X2NGJ922inmt86R_y4c",
            authDomain: "notice-board-website.firebaseapp.com",
            projectId: "notice-board-website",
            storageBucket: "notice-board-website.firebasestorage.app",
            messagingSenderId: "119514838081",
            appId: "1:119514838081:web:195380f17fb04f1f59c2c0",
            measurementId: "G-9CDXVTKD91"
        };
        const appId = firebaseConfig.appId; // Using appId from your config

        let db;
        let auth;
        let currentUserId = 'anonymous'; // Default until auth check completes

        // --- FIREBASE INITIALIZATION & AUTHENTICATION ---
        window.initFirebase = async () => {
            if (!firebaseConfig.apiKey) {
                console.error("Firebase config is missing. Cannot initialize Firestore.");
                document.getElementById('post-form').innerHTML = '<p class="text-red-500 font-semibold">Error: Firebase configuration is missing. Cannot save posts.</p>';
                return;
            }

            const app = initializeApp(firebaseConfig);
            // Initialize services *after* initializing the app
            db = getFirestore(app);
            auth = getAuth(app);

            // 1. Authenticate (using anonymous sign-in for simplicity)
            try {
                const userCredential = await signInAnonymously(auth);
                currentUserId = userCredential.user.uid;
                console.log("Signed in anonymously. User ID:", currentUserId);
            } catch (error) {
                console.error("Firebase Authentication failed:", error);
                // Fallback to random ID if auth fails completely
                currentUserId = crypto.randomUUID();
            }

            // 2. Start Real-time Listeners
            startPostListener();
            document.getElementById('current-user-id').textContent = currentUserId;

            // 3. Attach Submit Handler
            document.getElementById('post-form').addEventListener('submit', handlePostSubmit);
        };

        // --- FIRESTORE DATA PATH & OPERATIONS ---
        const getCollectionRef = () => {
            // We use a simple collection name now that the external environment setup is gone.
            const publicDataPath = `locallink_posts`; 
            return collection(db, publicDataPath);
        };

        const startPostListener = () => {
            if (!db) return;

            const postsCollectionRef = getCollectionRef();
            const q = query(postsCollectionRef);

            onSnapshot(q, (snapshot) => {
                const posts = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                renderPosts(posts);
            }, (error) => {
                console.error("Error listening to posts:", error);
            });
        };

        const handlePostSubmit = async (event) => {
            event.preventDefault();
            
            const form = event.target;
            const type = form.elements['post-type'].value;
            const title = form.elements['title'].value.trim();
            const description = form.elements['description'].value.trim();
            const contact = form.elements['contact'].value.trim();
            const price = type === 'exchange' ? form.elements['price'].value.trim() : '';

            if (!title || !description || !contact) {
                showMessage("Please fill in all required fields.", "error");
                return;
            }

            const newPost = {
                type,
                title,
                description,
                contact,
                price: price || null,
                timestamp: Timestamp.now(),
                userId: currentUserId,
            };

            try {
                await addDoc(getCollectionRef(), newPost);
                form.reset();
                showMessage(`New ${type} post added successfully!`, "success");
            } catch (error) {
                console.error("Error adding document: ", error);
                showMessage("Failed to submit post. Check console for details.", "error");
            }
        };

        // --- UI RENDERING & LOGIC ---

        const renderPosts = (posts) => {
            const noticeBoard = document.getElementById('notice-board-content');
            const exchangeBoard = document.getElementById('exchange-board-content');
            noticeBoard.innerHTML = '';
            exchangeBoard.innerHTML = '';

            // Sort by latest first
            posts.sort((a, b) => {
                const aTime = a.timestamp ? a.timestamp.seconds : 0;
                const bTime = b.timestamp ? b.timestamp.seconds : 0;
                return bTime - aTime;
            });

            if (posts.length === 0) {
                noticeBoard.innerHTML = '<p class="text-gray-500 p-6 text-center">No community notices posted yet.</p>';
                exchangeBoard.innerHTML = '<p class="text-gray-500 p-6 text-center">No items listed for exchange yet.</p>';
                return;
            }

            let hasNotices = false;
            let hasExchanges = false;

            posts.forEach(post => {
                const postElement = createPostCard(post);
                if (post.type === 'notice') {
                    noticeBoard.appendChild(postElement);
                    hasNotices = true;
                } else if (post.type === 'exchange') {
                    exchangeBoard.appendChild(postElement);
                    hasExchanges = true;
                }
            });

            if (!hasNotices) {
                noticeBoard.innerHTML = '<p class="text-gray-500 p-6 text-center">No community notices posted yet.</p>';
            }
            if (!hasExchanges) {
                exchangeBoard.innerHTML = '<p class="text-gray-500 p-6 text-center">No items listed for exchange yet.</p>';
            }
        };

        const createPostCard = (post) => {
            const isExchange = post.type === 'exchange';
            const card = document.createElement('div');
            card.className = `bg-white shadow-lg rounded-xl p-5 mb-4 border-l-4 ${isExchange ? 'border-amber-500' : 'border-blue-500'} transition transform hover:shadow-xl`;

            const date = post.timestamp ? new Date(post.timestamp.seconds * 1000).toLocaleDateString() : 'N/A';

            card.innerHTML = `
                <div class="flex justify-between items-start mb-2">
                    <h3 class="text-xl font-bold ${isExchange ? 'text-amber-700' : 'text-blue-700'}">${post.title}</h3>
                    <span class="text-xs text-gray-500 bg-gray-100 px-3 py-1 rounded-full">${isExchange ? 'Exchange/Sell' : 'Community Notice'}</span>
                </div>
                ${isExchange && post.price ? `<p class="text-2xl font-extrabold text-green-600 mb-3">${post.price}</p>` : ''}
                <p class="text-gray-600 mb-4">${post.description}</p>
                <div class="pt-3 border-t border-gray-100">
                    <p class="text-sm font-medium text-gray-700">Contact: <span class="font-bold text-indigo-600">${post.contact}</span></p>
                    <p class="text-xs text-gray-400 mt-1">Posted on: ${date} by User ID: ${post.userId.substring(0, 8)}...</p>
                </div>
            `;
            return card;
        };

        const switchTab = (tabId) => {
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(tabId).classList.remove('hidden');

            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('bg-indigo-600', 'text-white');
                button.classList.add('text-indigo-600', 'hover:bg-indigo-50');
            });

            const activeBtn = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            activeBtn.classList.add('bg-indigo-600', 'text-white');
            activeBtn.classList.remove('text-indigo-600', 'hover:bg-indigo-50');
        };

        const toggleForm = () => {
            const formContainer = document.getElementById('form-container');
            const button = document.getElementById('toggle-form-btn');
            const isHidden = formContainer.classList.toggle('hidden');
            button.textContent = isHidden ? '+ Post New Item/Notice' : 'âˆ’ Close Posting Form';
        };

        const updatePriceVisibility = () => {
            const type = document.getElementById('post-type').value;
            const priceGroup = document.getElementById('price-group');
            if (type === 'exchange') {
                priceGroup.classList.remove('hidden');
            } else {
                priceGroup.classList.add('hidden');
            }
        };

        const showMessage = (message, type) => {
            const msgBox = document.getElementById('message-box');
            msgBox.textContent = message;
            msgBox.classList.remove('bg-green-100', 'bg-red-100', 'text-green-800', 'text-red-800', 'hidden');
            msgBox.classList.add(
                type === 'success' ? 'bg-green-100' : 'bg-red-100',
                type === 'success' ? 'text-green-800' : 'text-red-800'
            );
            setTimeout(() => {
                msgBox.classList.add('hidden');
            }, 5000);
        };

        // --- SETUP ON WINDOW LOAD ---
        window.onload = () => {
            // Setup tab switching and form toggles
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', () => switchTab(button.dataset.tab));
            });
            document.getElementById('toggle-form-btn').addEventListener('click', toggleForm);
            document.getElementById('post-type').addEventListener('change', updatePriceVisibility);

            // Initialize the default view
            switchTab('notice-board');
            updatePriceVisibility();

            // Start Firebase after the page is set up
            initFirebase();
        };

        // Expose function for tab switching (for initial setup)
        window.switchTab = switchTab;
    </script>
    <style>
        /* Custom scrollbar for better aesthetics */
        ::-webkit-scrollbar {
            width: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #a5b4fc;
            border-radius: 10px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #818cf8;
        }
        /* Inter font setup (Tailwind default is Inter, but good practice to confirm) */
        html {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">

    <header class="bg-indigo-700 shadow-md py-4">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <h1 class="text-3xl font-extrabold text-white">LocalLink <span class="text-indigo-200 text-base">Meerut Community Hub</span></h1>
            <p class="text-sm text-indigo-300 mt-1">A platform for Notices & Local Exchange</p>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">

        <!-- User ID Display for Collaboration -->
        <div class="mb-6 p-3 bg-indigo-50 border border-indigo-200 rounded-lg text-sm text-indigo-800">
            <span class="font-semibold">Your User ID:</span> <span id="current-user-id" class="break-all font-mono">Loading...</span>
            <p class="text-xs mt-1">Share this ID to identify your posts in a collaborative environment.</p>
        </div>

        <!-- Message Box -->
        <div id="message-box" class="hidden p-3 rounded-lg text-center font-medium mb-4 transition-all duration-300"></div>

        <!-- Posting Form Toggle Button -->
        <div class="mb-6">
            <button id="toggle-form-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-3 px-4 rounded-xl shadow-md transition duration-150 ease-in-out focus:outline-none focus:ring-2 focus:ring-green-400 focus:ring-opacity-75">
                + Post New Item/Notice
            </button>
        </div>

        <!-- Posting Form Container -->
        <div id="form-container" class="hidden bg-white p-6 rounded-xl shadow-2xl mb-8 border border-gray-200">
            <h2 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Submit a Post</h2>
            <form id="post-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <!-- Post Type -->
                    <div>
                        <label for="post-type" class="block text-sm font-medium text-gray-700">Post Type</label>
                        <select id="post-type" name="post-type" required class="mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-lg shadow-sm">
                            <option value="notice">Community Notice (Event, Job, Service)</option>
                            <option value="exchange">Buy, Sell, or Donate Item (Exchange)</option>
                        </select>
                    </div>
                    <!-- Title -->
                    <div>
                        <label for="title" class="block text-sm font-medium text-gray-700">Title</label>
                        <input type="text" id="title" name="title" required placeholder="e.g., Volunteer Drive, Used Bicycle" maxlength="50" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5">
                    </div>
                </div>

                <!-- Price (Conditional) -->
                <div id="price-group" class="mt-4 hidden">
                    <label for="price" class="block text-sm font-medium text-gray-700">Price / Status (e.g., Free, â‚¹500)</label>
                    <input type="text" id="price" name="price" placeholder="Enter Price or 'Free'" maxlength="20" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-amber-500 focus:ring-amber-500 p-2.5">
                </div>

                <!-- Description -->
                <div class="mt-4">
                    <label for="description" class="block text-sm font-medium text-gray-700">Description / Details</label>
                    <textarea id="description" name="description" rows="3" required placeholder="Provide details about the notice or the item for sale/exchange." class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5"></textarea>
                </div>

                <!-- Contact -->
                <div class="mt-4">
                    <label for="contact" class="block text-sm font-medium text-gray-700">Contact Information (Phone or Email)</label>
                    <input type="text" id="contact" name="contact" required placeholder="Your contact details for interested users" maxlength="50" class="mt-1 block w-full rounded-lg border-gray-300 shadow-sm focus:border-indigo-500 focus:ring-indigo-500 p-2.5">
                </div>

                <div class="mt-6">
                    <button type="submit" class="w-full flex justify-center py-2 px-4 border border-transparent rounded-xl shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-[1.01]">
                        Post to LocalLink
                    </button>
                </div>
            </form>
        </div>
        
        <!-- Tab Navigation -->
        <div class="flex space-x-2 border-b border-gray-200 mb-6">
            <button data-tab="notice-board" class="tab-button px-6 py-3 font-semibold text-lg rounded-t-xl transition duration-150 ease-in-out bg-indigo-600 text-white" onclick="window.switchTab('notice-board')">
                Community Notice Board
            </button>
            <button data-tab="exchange-board" class="tab-button px-6 py-3 font-semibold text-lg rounded-t-xl transition duration-150 ease-in-out text-indigo-600 hover:bg-indigo-50" onclick="window.switchTab('exchange-board')">
                Buy/Sell/Exchange
            </button>
        </div>

        <!-- Content Area -->
        <div class="mt-6">
            <!-- Notice Board Content -->
            <div id="notice-board" class="tab-content">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="notice-board-content">
                    <!-- Posts will be injected here by JavaScript -->
                    <p class="text-center col-span-full text-gray-500">Loading notices...</p>
                </div>
            </div>

            <!-- Exchange Board Content -->
            <div id="exchange-board" class="tab-content hidden">
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="exchange-board-content">
                    <!-- Posts will be injected here by JavaScript -->
                    <p class="text-center col-span-full text-gray-500">Loading listings...</p>
                </div>
            </div>
        </div>
    </main>

    <footer class="bg-gray-100 mt-10 py-4 border-t border-gray-200">
        <p class="text-center text-sm text-gray-500">LocalLink Project for Seva Sankalp Foundation, Meerut | Social Internship Technical Contribution</p>
    </footer>
</body>
</html>


